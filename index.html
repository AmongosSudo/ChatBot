<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FirstStep - Dispatcher Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #F7F8FA;
            --bg-secondary: #FFFFFF;
            --bg-third: #F1F5F9;
            --border-secondary: #E5E7EB;
            --text-orange: #F97316;
            --bg-orange: #F97316;
            --bg-orange-dark: #EA580C;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --text-tertiary: #9CA3AF;
            --status-available: #22C55E;
            --status-offline: #EF4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .card {
            background-color: var(--bg-secondary);
            border-radius: 20px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            border: 1px solid var(--border-secondary);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -4px rgba(0,0,0,0.07);
        }
        
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: var(--bg-secondary); margin: 5% auto; padding: 2rem; border: 1px solid var(--border-secondary); width: 90%; max-width: 600px; border-radius: 20px; position: relative; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity: 0; transform: scale(0.95);} to {opacity: 1; transform: scale(1);} }
        .close-button { color: var(--text-secondary); position: absolute; top: 1rem; right: 1.5rem; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: var(--text-primary); }

        .sidebar { width: 5rem; transition: width 0.3s ease-in-out; flex-shrink: 0; }
        .sidebar:hover { width: 16rem; }
        .sidebar .nav-link-title, .sidebar .logout-text { opacity: 0; transition: opacity 0.2s ease-in-out; white-space: nowrap; font-weight: 600; }
        .sidebar:hover .nav-link-title, .sidebar:hover .logout-text { opacity: 1; transition-delay: 0.1s; }
        
        .nav-link.active { background-color: var(--bg-orange); color: white; }
        .nav-link.active:hover { color: white; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .status-pill { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize; }
        .status-scheduled { background-color: #16a34a; color: #ffffff; }
        .status-needs-scheduling, .status-New { background-color: #ca8a04; color: #ffffff; }

    </style>
</head>

<body class="flex flex-col min-h-screen">
    <div class="flex flex-1 h-screen">
        <!-- Sidebar -->
        <aside class="sidebar bg-[var(--bg-secondary)] flex flex-col items-center py-6 border-r border-[var(--border-secondary)]">
            <div class="text-[var(--text-orange)] text-2xl font-bold mb-12">FS</div>
            <nav id="sidebar-nav" class="flex flex-col items-start w-full space-y-2 flex-grow justify-center px-4">
                <a href="#" data-tab="dashboard" class="nav-link active w-full flex items-center p-3 rounded-lg"><span class="material-icons">dashboard</span><span class="nav-link-title ml-4">Dashboard</span></a>
                <a href="#" data-tab="jobs" class="nav-link w-full flex items-center p-3 text-gray-500 hover:text-[var(--text-orange)] rounded-lg hover:bg-gray-100 transition-colors"><span class="material-icons">work</span><span class="nav-link-title ml-4">Jobs</span></a>
                <a href="#" data-tab="technicians" class="nav-link w-full flex items-center p-3 text-gray-500 hover:text-[var(--text-orange)] rounded-lg hover:bg-gray-100 transition-colors"><span class="material-icons">engineering</span><span class="nav-link-title ml-4">Technicians</span></a>
                <a href="#" data-tab="schedule" class="nav-link w-full flex items-center p-3 text-gray-500 hover:text-[var(--text-orange)] rounded-lg hover:bg-gray-100 transition-colors"><span class="material-icons">calendar_today</span><span class="nav-link-title ml-4">Schedule</span></a>
            </nav>
            <div class="w-full px-4">
                <div class="w-full flex items-center p-3">
                    <div class="w-10 h-10 rounded-full bg-[var(--bg-orange)] flex items-center justify-center text-white font-bold flex-shrink-0">A</div>
                    <span class="nav-link-title ml-4">Admin</span>
                </div>
                 <button class="w-full flex items-center p-3 text-gray-500 hover:text-red-500 rounded-lg hover:bg-red-50 transition-colors mt-2">
                    <span class="material-icons">logout</span>
                    <span class="logout-text ml-4">Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 sm:p-10 overflow-y-auto">
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-10">
                    <div>
                        <h1 class="text-3xl font-bold text-[var(--text-primary)]">Dispatcher Dashboard</h1>
                        <p class="text-base text-[var(--text-secondary)]">Overview of key metrics and performance indicators</p>
                    </div>
                    <button id="createJobBtn" class="bg-[var(--bg-orange)] text-white font-bold py-3 px-5 rounded-lg flex items-center space-x-2 hover:bg-[var(--bg-orange-dark)] transition-colors mt-4 sm:mt-0"><span class="material-icons">add</span><span>Create New Job</span></button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-10">
                    <div class="card flex justify-between items-center"><div><p class="text-sm text-[var(--text-secondary)]">Needs Scheduling</p><p id="pendingJobs" class="text-3xl font-bold text-[var(--text-primary)]">0</p></div><div class="p-3 bg-orange-100 rounded-full"><span class="material-icons text-orange-500 text-2xl">pending_actions</span></div></div>
                    <div class="card flex justify-between items-center"><div><p class="text-sm text-[var(--text-secondary)]">Total Technicians</p><p id="total-technicians-stat" class="text-3xl font-bold text-[var(--text-primary)]">0</p></div><div class="p-3 bg-blue-100 rounded-full"><span class="material-icons text-blue-500 text-2xl">engineering</span></div></div>
                    <div class="card flex justify-between items-center"><div><p class="text-sm text-[var(--text-secondary)]">Scheduled Jobs</p><p id="completedJobs" class="text-3xl font-bold text-[var(--text-primary)]">0</p></div><div class="p-3 bg-green-100 rounded-full"><span class="material-icons text-green-500 text-2xl">task_alt</span></div></div>
                    <div class="card flex justify-between items-center"><div><p class="text-sm text-[var(--text-secondary)]">Avg Response Time</p><p class="text-3xl font-bold text-[var(--text-primary)]">--</p></div><div class="p-3 bg-purple-100 rounded-full"><span class="material-icons text-purple-500 text-2xl">timer</span></div></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <div class="card h-full flex flex-col lg:col-span-3"><h2 class="text-xl font-bold mb-4">Online Technicians</h2><div id="technicians-list" class="space-y-3 flex-grow"><p class="text-gray-400">Loading technicians...</p></div></div>
                    <div class="card h-full flex flex-col lg:col-span-2"><h2 class="text-xl font-bold mb-4">Upcoming Jobs</h2><div class="text-center mb-4"><p id="calendar-date" class="text-4xl font-bold text-[var(--text-primary)]">01</p><p id="calendar-month-year" class="text-lg text-[var(--text-secondary)]">August, 2025</p></div><div id="jobs-list" class="space-y-3 flex-grow"><p class="text-gray-400">Loading jobs...</p></div></div>
                </div>
            </div>

            <!-- Jobs Tab -->
            <div id="jobs-tab" class="tab-content">
                 <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold">All Jobs</h1>
                        <p class="text-base text-[var(--text-secondary)]">Manage and view all customer job requests.</p>
                    </div>
                    <button id="createJobBtn2" class="bg-[var(--bg-orange)] text-white font-bold py-3 px-5 rounded-lg flex items-center space-x-2 hover:bg-[var(--bg-orange-dark)] transition-colors mt-4 sm:mt-0"><span class="material-icons">add</span><span>Create New Job</span></button>
                </div>
                <div class="bg-[var(--bg-secondary)] rounded-2xl shadow-lg overflow-hidden border border-[var(--border-secondary)]">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 border-b border-[var(--border-secondary)]">
                                <tr>
                                    <th class="p-4 text-sm font-semibold text-[var(--text-secondary)]">Customer Name</th>
                                    <th class="p-4 text-sm font-semibold text-[var(--text-secondary)]">Address</th>
                                    <th class="p-4 text-sm font-semibold text-[var(--text-secondary)]">Issue Reported</th>
                                    <th class="p-4 text-sm font-semibold text-[var(--text-secondary)]">Phone</th>
                                    <th class="p-4 text-sm font-semibold text-[var(--text-secondary)]">Status</th>
                                    <th class="p-4 text-sm font-semibold text-[var(--text-secondary)]">Action</th>
                                </tr>
                            </thead>
                            <tbody id="jobs-table-body" class="divide-y divide-[var(--border-secondary)] text-sm">
                                <tr><td colspan="6" class="p-4 text-center text-gray-400">Loading jobs... New jobs from emails will appear here automatically.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Technicians Tab -->
            <div id="technicians-tab" class="tab-content">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold">Technicians</h1>
                        <p class="text-base text-[var(--text-secondary)]">Manage and view technician status</p>
                    </div>
                    <button id="addTechnicianBtn" class="bg-[var(--bg-orange)] text-white font-bold py-3 px-5 rounded-lg flex items-center space-x-2 hover:bg-[var(--bg-orange-dark)] transition-colors"><span class="material-icons">add</span><span>Add Technician</span></button>
                </div>
                <div id="technicians-card-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 gap-6">
                     <p class="text-gray-400 col-span-full">Loading technicians...</p>
                </div>
            </div>

            <!-- Schedule Tab -->
            <div id="schedule-tab" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-xl font-bold">Route Optimization</h1>
                        <p class="text-xs text-[var(--text-secondary)]">Generate and approve optimized routes for today's jobs.</p>
                    </div>
                    <button id="optimizeRoutesBtn" class="bg-[var(--bg-orange)] text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 hover:bg-[var(--bg-orange-dark)] transition-colors text-sm"><span class="material-icons !text-xl">route</span><span>Optimize Routes</span></button>
                </div>
                <div class="card p-4">
                    <h2 class="text-lg font-bold mb-4 text-[var(--text-orange)]">Optimized Routes for Today</h2>
                    <div id="optimized-routes-container" class="space-y-4">
                         <p class="text-gray-400 text-center py-4">Click "Optimize Routes" to generate today's schedule.</p>
                    </div>
                    <div id="approve-routes-section" class="mt-6 text-center" style="display: none;">
                        <button id="approveRoutesBtn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg flex items-center space-x-2 hover:bg-green-700 transition-colors mx-auto"><span class="material-icons">check_circle</span><span>Approve and Send Routes</span></button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <footer class="bg-[var(--bg-third)] text-[var(--text-secondary)] py-4 px-8 border-t border-[var(--border-secondary)]"><div class="container mx-auto text-center"><p class="text-sm"><span class="font-bold text-xl text-[var(--text-primary)]">FirstStep</span> &copy; 2025. All rights reserved.</p></div></footer>

    <!-- Modals -->
    <div id="jobModal" class="modal"><div class="modal-content"><span class="close-button" id="closeJobModal">&times;</span><h2 class="text-2xl font-bold mb-6 text-center">Create a New Job</h2><form id="jobForm"><div class="mb-4"><label for="customerName" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Customer Name</label><input type="text" id="customerName" name="customerName" class="w-full bg-gray-50 border border-[var(--border-secondary)] rounded-lg px-3 py-2 focus:ring-[var(--text-orange)] focus:border-[var(--text-orange)]" required></div><div class="mb-4"><label for="jobIssue" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Issue Reported</label><textarea id="jobIssue" name="jobIssue" rows="3" class="w-full bg-gray-50 border border-[var(--border-secondary)] rounded-lg px-3 py-2 focus:ring-[var(--text-orange)] focus:border-[var(--text-orange)]" required></textarea></div><div class="mb-4"><label for="jobLocation" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Address</label><input type="text" id="jobLocation" name="jobLocation" class="w-full bg-gray-50 border border-[var(--border-secondary)] rounded-lg px-3 py-2 focus:ring-[var(--text-orange)] focus:border-[var(--text-orange)]" required></div><div class="mb-6"><label for="customerPhone" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Phone</label><input type="tel" id="customerPhone" name="customerPhone" class="w-full bg-gray-50 border border-[var(--border-secondary)] rounded-lg px-3 py-2 focus:ring-[var(--text-orange)] focus:border-[var(--text-orange)]" required></div><button type="submit" class="w-full bg-[var(--bg-orange)] text-white font-bold py-3 px-6 rounded-lg hover:bg-[var(--bg-orange-dark)] transition-colors">Add Job</button></form></div></div>
    <div id="techModal" class="modal"><div class="modal-content"><span class="close-button" id="closeTechModal">&times;</span><h2 class="text-2xl font-bold mb-6 text-center">Add New Technician</h2><form id="techForm"><div class="mb-4"><label for="techName" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Technician Name</label><input type="text" id="techName" name="techName" class="w-full bg-gray-50 border border-[var(--border-secondary)] rounded-lg px-3 py-2 focus:ring-[var(--text-orange)] focus:border-[var(--text-orange)]" required></div><div class="mb-6"><label for="techLocation" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Location</label><input type="text" id="techLocation" name="techLocation" class="w-full bg-gray-50 border border-[var(--border-secondary)] rounded-lg px-3 py-2 focus:ring-[var(--text-orange)] focus:border-[var(--text-orange)]" required></div><button type="submit" class="w-full bg-[var(--bg-orange)] text-white font-bold py-3 px-6 rounded-lg hover:bg-[var(--bg-orange-dark)] transition-colors">Add Technician</button></form></div></div>
    <div id="manageTechModal" class="modal"><div class="modal-content"><span class="close-button" id="closeManageTechModal">&times;</span><h2 class="text-2xl font-bold mb-6 text-center">Manage Technician</h2><form id="manageTechForm"><input type="hidden" id="manageTechId"><div class="mb-4"><label for="manageTechName" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Technician Name</label><input type="text" id="manageTechName" name="manageTechName" class="w-full bg-gray-100 border border-[var(--border-secondary)] rounded-lg px-3 py-2" disabled></div><div class="mb-4"><label for="manageTechLocation" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Location</label><input type="text" id="manageTechLocation" name="manageTechLocation" class="w-full bg-gray-50 border border-[var(--border-secondary)] rounded-lg px-3 py-2 focus:ring-[var(--text-orange)] focus:border-[var(--text-orange)]" required></div><div class="mb-6"><label for="manageTechCapacity" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Capacity (Max Jobs)</label><input type="number" id="manageTechCapacity" name="manageTechCapacity" class="w-full bg-gray-50 border border-[var(--border-secondary)] rounded-lg px-3 py-2 focus:ring-[var(--text-orange)] focus:border-[var(--text-orange)]" required min="1"></div><button type="submit" class="w-full bg-[var(--bg-orange)] text-white font-bold py-3 px-6 rounded-lg hover:bg-[var(--bg-orange-dark)] transition-colors">Save Changes</button></form></div></div>
    <div id="scheduleJobModal" class="modal"><div class="modal-content"><span class="close-button" id="closeScheduleJobModal">&times;</span><h2 class="text-2xl font-bold mb-4 text-center">Schedule Job</h2><div class="text-sm space-y-2 mb-4 border-b border-[var(--border-secondary)] pb-4"><p><strong class="font-semibold text-gray-600">Customer:</strong> <span id="schedule-customer-name"></span></p><p><strong class="font-semibold text-gray-600">Address:</strong> <span id="schedule-address"></span></p><p><strong class="font-semibold text-gray-600">Issue:</strong> <span id="schedule-issue"></span></p><p><strong class="font-semibold text-gray-600">Warranty Provider:</strong> <span id="schedule-warranty"></span></p><p><strong class="font-semibold text-gray-600">Plan Type:</strong> <span id="schedule-plan"></span></p><p><strong class="font-semibold text-gray-600">Dispatch/PO Number:</strong> <span id="schedule-dispatch"></span></p></div><form id="scheduleJobForm"><input type="hidden" id="scheduleJobId"><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div class="mb-4"><label for="scheduleDate" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Select Date</label><input type="date" id="scheduleDate" name="scheduleDate" class="w-full bg-gray-50 border border-[var(--border-secondary)] rounded-lg px-3 py-2 focus:ring-[var(--text-orange)] focus:border-[var(--text-orange)]" required></div><div class="mb-4"><label for="scheduleTime" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Select Time Slot</label><select id="scheduleTime" name="scheduleTime" class="w-full bg-gray-50 border border-[var(--border-secondary)] rounded-lg px-3 py-2 focus:ring-[var(--text-orange)] focus:border-[var(--text-orange)]" required><option>08:00 AM - 10:00 AM</option><option>10:00 AM - 12:00 PM</option><option>12:00 PM - 02:00 PM</option><option>02:00 PM - 04:00 PM</option><option>04:00 PM - 06:00 PM</option></select></div><div class="col-span-full"><label for="assignTechnician" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Assign Technician</label><select id="assignTechnician" name="assignTechnician" class="w-full bg-gray-50 border border-[var(--border-secondary)] rounded-lg px-3 py-2 focus:ring-[var(--text-orange)] focus:border-[var(--text-orange)]" required></select></div></div><button type="submit" class="w-full bg-[var(--bg-orange)] text-white font-bold py-3 px-6 rounded-lg hover:bg-[var(--bg-orange-dark)] transition-colors mt-6">Schedule Job</button></form></div></div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCSi3xtGBZ1I5ZBRdckcM0C-FkOyp0SHDw",
            authDomain: "polished-bounty-467515-r8.firebaseapp.com",
            projectId: "polished-bounty-467515-r8",
            storageBucket: "polished-bounty-467515-r8.appspot.com",
            messagingSenderId: "769234521307",
            appId: "1:769234521307:web:52266813e0bce07ea350fe"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- Global State ---
        let technicians = [];
        let jobs = [];
        let optimizedRoutes = null; // To store the AI's response

        // --- UI Elements ---
        const techniciansList = document.getElementById('technicians-list');
        const jobsList = document.getElementById('jobs-list');
        const jobsTableBody = document.getElementById('jobs-table-body');
        const techniciansCardGrid = document.getElementById('technicians-card-grid');
        const scheduleContainer = document.getElementById('schedule-container');
        const calendarDate = document.getElementById('calendar-date');
        const calendarMonthYear = document.getElementById('calendar-month-year');
        const pendingJobsEl = document.getElementById('pendingJobs');
        const completedJobsEl = document.getElementById('completedJobs');
        const totalTechsStatEl = document.getElementById('total-technicians-stat');
        const optimizeRoutesBtn = document.getElementById('optimizeRoutesBtn');
        const optimizedRoutesContainer = document.getElementById('optimized-routes-container');
        const approveRoutesSection = document.getElementById('approve-routes-section');
        const approveRoutesBtn = document.getElementById('approveRoutesBtn');
        
        // --- Modals and Forms ---
        const jobModal = document.getElementById('jobModal');
        const createJobBtn = document.getElementById('createJobBtn');
        const createJobBtn2 = document.getElementById('createJobBtn2');
        const closeJobModalBtn = document.getElementById('closeJobModal');
        const jobForm = document.getElementById('jobForm');
        const techModal = document.getElementById('techModal');
        const addTechnicianBtn = document.getElementById('addTechnicianBtn');
        const closeTechModalBtn = document.getElementById('closeTechModal');
        const techForm = document.getElementById('techForm');
        const manageTechModal = document.getElementById('manageTechModal');
        const closeManageTechModalBtn = document.getElementById('closeManageTechModal');
        const manageTechForm = document.getElementById('manageTechForm');
        const scheduleJobModal = document.getElementById('scheduleJobModal');
        const closeScheduleJobModalBtn = document.getElementById('closeScheduleJobModal');
        const scheduleJobForm = document.getElementById('scheduleJobForm');
        const assignTechnicianSelect = document.getElementById('assignTechnician');
        
        // --- Navigation ---
        const sidebarNav = document.getElementById('sidebar-nav');
        const navLinks = sidebarNav.querySelectorAll('.nav-link');
        const tabContents = document.querySelectorAll('.tab-content');

        // --- Render Functions (Existing functions are unchanged) ---
        const renderTechniciansList = () => {
            if (!techniciansList) return;
            techniciansList.innerHTML = '';
            const onlineTechs = technicians.filter(t => t.status === 'Available').slice(0, 3);
            if (onlineTechs.length === 0) {
                 techniciansList.innerHTML = `<p class="text-gray-400">No technicians online.</p>`;
                 return;
            }
            onlineTechs.forEach(tech => {
                const techElement = document.createElement('div');
                techElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                techElement.innerHTML = `<div class="flex items-center space-x-3"><img alt="${tech.name}" class="w-10 h-10 rounded-full" src="${tech.avatar}" onerror="this.onerror=null;this.src='https://placehold.co/40x40/FFA500/000000?text=${tech.name.charAt(0)}';"><div><p class="font-semibold text-sm text-[var(--text-primary)]">${tech.name}</p><p class="text-xs text-[var(--text-tertiary)]">ID: ${tech.id.substring(0, 7)}...</p></div></div><div class="flex items-center space-x-2"><div class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse"></div><span class="text-xs text-[var(--text-secondary)]">Online</span></div>`;
                techniciansList.appendChild(techElement);
            });
        };
        
        const renderTechniciansCards = () => {
            if (!techniciansCardGrid) return;
            techniciansCardGrid.innerHTML = '';
            if (technicians.length === 0) {
                techniciansCardGrid.innerHTML = `<p class="text-gray-400 col-span-full">No technicians found. Add one to get started.</p>`;
                return;
            }
            technicians.forEach(tech => {
                const isAvailable = tech.status === 'Available';
                const statusColor = isAvailable ? 'var(--status-available)' : 'var(--status-offline)';
                const card = document.createElement('div');
                card.className = 'card p-4 flex flex-col justify-between';
                card.innerHTML = `
                    <div>
                        <p class="text-lg font-bold text-[var(--text-primary)] mb-2">${tech.name}</p>
                        <div class="flex items-center text-sm text-[var(--text-secondary)] mb-2">
                            <span class="material-icons text-base mr-2">location_on</span>
                            <span>${tech.location}</span>
                        </div>
                        <div class="flex items-center text-sm text-[var(--text-secondary)] mb-4">
                            <span class="material-icons text-base mr-2">work_history</span>
                            <span>Capacity: ${tech.capacity} jobs</span>
                        </div>
                    </div>
                    <div class="flex flex-col items-start space-y-2">
                         <div class="flex items-center">
                            <div class="w-2.5 h-2.5 rounded-full mr-2" style="background-color: ${statusColor};"></div>
                            <p class="text-sm font-medium" style="color: ${statusColor};">${tech.status}</p>
                        </div>
                        <button data-id="${tech.id}" class="manage-tech-btn w-full bg-[var(--bg-orange)]/20 text-[var(--text-orange)] py-1.5 px-4 rounded-md hover:bg-[var(--bg-orange)]/40 transition-colors text-sm font-medium">Manage</button>
                    </div>
                `;
                techniciansCardGrid.appendChild(card);
            });
        };

        const renderUpcomingJobs = () => {
            if (!jobsList) return;
            jobsList.innerHTML = '';
            const upcoming = jobs.filter(job => job.status === 'needs-scheduling').slice(0, 3);
             if (upcoming.length === 0) {
                jobsList.innerHTML = `<p class="text-gray-400">No upcoming jobs.</p>`;
                return;
            }
            upcoming.forEach(job => {
                const jobElement = document.createElement('div');
                jobElement.className = 'p-3 bg-gray-50 rounded-lg';
                jobElement.innerHTML = `<p class="font-semibold text-sm text-[var(--text-primary)]">${job.issue}</p><p class="text-xs text-[var(--text-tertiary)]">${job.customerName} | ${job.address}</p>`;
                jobsList.appendChild(jobElement);
            });
        };

        const renderJobsTable = () => {
            if (!jobsTableBody) return;
            jobsTableBody.innerHTML = '';
            if (jobs.length === 0) {
                jobsTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-400">No jobs found. New jobs from emails will appear here automatically.</td></tr>`;
                return;
            }
            jobs.forEach(job => {
                const statusClass = `status-${job.status.replace(/ /g, '-')}`;
                const statusText = job.status.replace(/-/g, ' ');
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `<td class="p-4 whitespace-nowrap text-gray-800">${job.customerName || 'N/A'}</td><td class="p-4 whitespace-nowrap text-[var(--text-tertiary)]">${job.address || 'N/A'}</td><td class="p-4 whitespace-nowrap text-[var(--text-tertiary)]">${job.issue || 'N/A'}</td><td class="p-4 whitespace-nowrap text-[var(--text-tertiary)]">${job.phone || 'N/A'}</td><td class="p-4 whitespace-nowrap"><span class="status-pill ${statusClass}">${statusText}</span></td><td class="p-4 whitespace-nowrap"><button data-id="${job.id}" class="view-job-btn bg-[var(--bg-orange)]/20 text-[var(--text-orange)] py-1 px-4 rounded-md hover:bg-[var(--bg-orange)]/40 transition-colors text-sm font-medium">Schedule</button></td>`;
                jobsTableBody.appendChild(row);
            });
        };
        
        const renderSchedule = () => {
            if (!scheduleContainer) return;
            scheduleContainer.innerHTML = '';
            const scheduledJobs = jobs.filter(job => job.status === 'scheduled' && job.technicianId);
            if (scheduledJobs.length === 0) {
                scheduleContainer.innerHTML = `<p class="text-gray-400">No jobs scheduled for today.</p>`;
                return;
            }
            const jobsByTech = scheduledJobs.reduce((acc, job) => {
                (acc[job.technicianId] = acc[job.technicianId] || []).push(job);
                return acc;
            }, {});

            for (const techId in jobsByTech) {
                const tech = technicians.find(t => t.id === techId);
                if (!tech) continue;

                const techScheduleCard = document.createElement('div');
                techScheduleCard.className = 'p-3 bg-gray-50 rounded-lg';
                
                let jobsHtml = '';
                jobsByTech[techId].forEach(job => {
                    const scheduledTime = job.scheduledTime || "TBD";
                    const scheduledEndTime = job.scheduledEndTime || "TBD";
                    const startTimeParts = scheduledTime.split(' ');
                    const endTimeParts = scheduledEndTime.split(' ');
                    
                    jobsHtml += `
                        <div class="flex items-start space-x-4">
                            <div class="flex flex-col items-center w-16 shrink-0">
                                <div class="text-center">
                                    <p class="font-bold text-sm text-gray-800">${startTimeParts[0]}</p>
                                    <p class="text-xs text-[var(--text-tertiary)]">${startTimeParts[1] || ''}</p>
                                </div>
                                <div class="w-px h-3 bg-[var(--border-secondary)] my-1"></div>
                                <div class="text-center">
                                    <p class="font-bold text-sm text-gray-800">${endTimeParts[0]}</p>
                                    <p class="text-xs text-[var(--text-tertiary)]">${endTimeParts[1] || ''}</p>
                                </div>
                            </div>
                            <div class="pt-0">
                                <p class="font-semibold text-sm text-gray-800">${job.issue}</p>
                                <p class="text-xs text-[var(--text-secondary)]">${job.address}</p>
                            </div>
                        </div>
                    `;
                });

                techScheduleCard.innerHTML = `
                    <div class="flex items-center space-x-3 mb-3 pb-3 border-b border-[var(--border-secondary)]">
                        <img alt="${tech.name}" class="w-8 h-8 rounded-full" src="${tech.avatar}" onerror="this.onerror=null;this.src='https://placehold.co/32x32/FFA500/000000?text=${tech.name.charAt(0)}';">
                        <div>
                            <p class="font-bold text-base text-gray-800">${tech.name}</p>
                            <p class="text-xs text-[var(--text-tertiary)]">${tech.id.substring(0,7)}...</p>
                        </div>
                    </div>
                    <div class="space-y-4">${jobsHtml}</div>
                `;
                scheduleContainer.appendChild(techScheduleCard);
            }
        };

        const updateStats = () => {
            if (pendingJobsEl) pendingJobsEl.textContent = jobs.filter(j => j.status === 'needs-scheduling' || j.status === 'New').length;
            if (completedJobsEl) completedJobsEl.textContent = jobs.filter(j => j.status === 'scheduled').length;
            if (totalTechsStatEl) totalTechsStatEl.textContent = technicians.length;
        };

        const setCalendarDate = () => {
            if (!calendarDate || !calendarMonthYear) return;
            const now = new Date();
            calendarDate.textContent = now.getDate();
            calendarMonthYear.textContent = `${now.toLocaleString('default', { month: 'long' })}, ${now.getFullYear()}`;
        };

        const renderAll = () => {
            renderTechniciansList();
            renderTechniciansCards();
            renderUpcomingJobs();
            renderJobsTable();
            renderSchedule();
            updateStats();
        };

        // --- Event Listeners (Existing listeners are unchanged) ---
        sidebarNav.addEventListener('click', (e) => {
            const link = e.target.closest('.nav-link');
            if (!link) return;
            e.preventDefault();
            const tabId = link.dataset.tab;
            navLinks.forEach(navLink => {
                navLink.classList.remove('active');
                navLink.classList.add('text-gray-500', 'hover:text-[var(--text-orange)]', 'hover:bg-gray-100');
            });
            tabContents.forEach(tab => tab.classList.remove('active'));
            link.classList.add('active');
            link.classList.remove('text-gray-500', 'hover:text-[var(--text-orange)]', 'hover:bg-gray-100');
            const activeTab = document.getElementById(`${tabId}-tab`);
            if (activeTab) activeTab.classList.add('active');
        });

        const openJobModal = () => jobModal.style.display = 'block';
        const closeJobModal = () => jobModal.style.display = 'none';
        const openTechModal = () => techModal.style.display = 'block';
        const closeTechModal = () => techModal.style.display = 'none';
        const openManageTechModal = (tech) => {
            document.getElementById('manageTechId').value = tech.id;
            document.getElementById('manageTechName').value = tech.name;
            document.getElementById('manageTechLocation').value = tech.location;
            document.getElementById('manageTechCapacity').value = tech.capacity;
            manageTechModal.style.display = 'block';
        };
        const closeManageTechModal = () => manageTechModal.style.display = 'none';
        const openScheduleJobModal = (job) => {
            document.getElementById('scheduleJobId').value = job.id;
            document.getElementById('schedule-customer-name').textContent = job.customerName;
            document.getElementById('schedule-address').textContent = job.address;
            document.getElementById('schedule-issue').textContent = job.issue;
            document.getElementById('schedule-warranty').textContent = job.warrantyProvider || 'N/A';
            document.getElementById('schedule-plan').textContent = job.planType || 'N/A';
            document.getElementById('schedule-dispatch').textContent = job.dispatchPoNumber || 'N/A';
            
            assignTechnicianSelect.innerHTML = '<option value="">Select a technician...</option>';
            technicians.forEach(tech => {
                const option = document.createElement('option');
                option.value = tech.id;
                option.textContent = `${tech.name} (${tech.location})`;
                assignTechnicianSelect.appendChild(option);
            });

            scheduleJobModal.style.display = 'block';
        };
        const closeScheduleJobModal = () => scheduleJobModal.style.display = 'none';

        if (createJobBtn) createJobBtn.onclick = openJobModal;
        if (createJobBtn2) createJobBtn2.onclick = openJobModal;
        if (closeJobModalBtn) closeJobModalBtn.onclick = closeJobModal;
        
        if (addTechnicianBtn) addTechnicianBtn.onclick = openTechModal;
        if (closeTechModalBtn) closeTechModalBtn.onclick = closeTechModal;
        
        if (closeManageTechModalBtn) closeManageTechModalBtn.onclick = closeManageTechModal;
        if (closeScheduleJobModalBtn) closeScheduleJobModalBtn.onclick = closeScheduleJobModal;

        techniciansCardGrid.addEventListener('click', (e) => {
            const button = e.target.closest('.manage-tech-btn');
            if (button) {
                const techId = button.dataset.id;
                const tech = technicians.find(t => t.id === techId);
                if (tech) openManageTechModal(tech);
            }
        });
        
        jobsTableBody.addEventListener('click', (e) => {
            const button = e.target.closest('.view-job-btn');
            if (button) {
                const jobId = button.dataset.id;
                const job = jobs.find(j => j.id === jobId);
                if (job) openScheduleJobModal(job);
            }
        });

        window.onclick = (event) => { 
            if (event.target == jobModal) closeJobModal();
            if (event.target == techModal) closeTechModal();
            if (event.target == manageTechModal) closeManageTechModal();
            if (event.target == scheduleJobModal) closeScheduleJobModal();
        };
        
        // --- Firestore Logic (Existing logic is unchanged) ---
        async function setupFirestoreListeners() {
            const jobsCollectionRef = collection(db, "service_calls");
            const techniciansCollectionRef = collection(db, "technicians");

            onSnapshot(jobsCollectionRef, (snapshot) => {
                jobs = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        customerName: data.customerName,
                        address: data.customerAddress,
                        issue: data.jobDescription,
                        phone: data.customerPhone,
                        status: data.status === 'New' ? 'needs-scheduling' : data.status,
                        technicianId: data.technicianId || null,
                        scheduledTime: data.scheduledTime || 'TBD',
                        scheduledEndTime: data.scheduledEndTime || 'TBD',
                        warrantyProvider: data.warrantyProvider || 'N/A',
                        planType: data.planType || 'N/A',
                        dispatchPoNumber: data.dispatchOrPoNumber || 'N/A'
                    };
                });
                renderAll();
            });

            onSnapshot(techniciansCollectionRef, (snapshot) => {
                technicians = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });
        }

        if (jobForm) {
            jobForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    await addDoc(collection(db, "service_calls"), {
                        customerName: jobForm.customerName.value,
                        customerAddress: jobForm.jobLocation.value,
                        jobDescription: jobForm.jobIssue.value,
                        customerPhone: jobForm.customerPhone.value,
                        status: 'New',
                        receivedAt: serverTimestamp()
                    });
                    closeJobModal();
                    jobForm.reset();
                } catch (error) {
                    console.error("Error adding job to Firestore: ", error);
                }
            });
        }

        if (techForm) {
            techForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newId = `T-${Math.floor(10000 + Math.random() * 90000)}`;
                try {
                    await addDoc(collection(db, "technicians"), {
                        name: techForm.techName.value,
                        location: techForm.techLocation.value,
                        status: 'Available', 
                        avatar: `https://i.pravatar.cc/150?u=${newId}`,
                        capacity: 5 
                    });
                    closeTechModal();
                    techForm.reset();
                } catch (error) {
                    console.error("Error adding technician to Firestore: ", error);
                }
            });
        }
        
        if (manageTechForm) {
            manageTechForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const techId = document.getElementById('manageTechId').value;
                const docRef = doc(db, "technicians", techId);
                try {
                    await updateDoc(docRef, {
                        location: document.getElementById('manageTechLocation').value,
                        capacity: parseInt(document.getElementById('manageTechCapacity').value, 10)
                    });
                    closeManageTechModal();
                } catch (error) {
                    console.error("Error updating technician: ", error);
                }
            });
        }
        
        if (scheduleJobForm) {
            scheduleJobForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const jobId = document.getElementById('scheduleJobId').value;
                const docRef = doc(db, "service_calls", jobId);
                const timeSlot = document.getElementById('scheduleTime').value;
                const [startTime, endTime] = timeSlot.split(' - ');
                try {
                    await updateDoc(docRef, {
                        status: 'scheduled',
                        scheduledTime: startTime,
                        scheduledEndTime: endTime,
                        scheduledDate: document.getElementById('scheduleDate').value,
                        technicianId: document.getElementById('assignTechnician').value
                    });
                    closeScheduleJobModal();
                } catch (error) {
                    console.error("Error scheduling job: ", error);
                }
            });
        }

        // --- NEW: Route Optimization Logic ---
        async function handleOptimizeRoutes() {
            optimizedRoutesContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Optimizing routes, please wait...</p>';
            approveRoutesSection.style.display = 'none';

            const scheduledJobs = jobs.filter(job => job.status === 'scheduled' && job.technicianId);
            if (scheduledJobs.length === 0) {
                optimizedRoutesContainer.innerHTML = '<p class="text-red-500 text-center py-4">No scheduled jobs to optimize.</p>';
                return;
            }

            const jobsByTech = scheduledJobs.reduce((acc, job) => {
                const tech = technicians.find(t => t.id === job.technicianId);
                if (tech) {
                    (acc[tech.name] = acc[tech.name] || []).push({
                        jobId: job.id,
                        address: job.address,
                        issue: job.issue
                    });
                }
                return acc;
            }, {});

            const prompt = `
                You are a logistics optimization expert for a technician dispatch company.
                Given the following list of jobs for each technician for today, create the most efficient route.
                Consider the shortest travel time between locations, avoiding traffic, and saving fuel.
                The starting point for each technician is their home location, which you can assume is near their first job.
                
                For each technician, provide a JSON object with the technician's name and an array of their jobs in the optimized order. Each job in the array should be an object with 'jobId', 'address', and 'issue'.
                
                Technician Jobs:
                ${JSON.stringify(jobsByTech, null, 2)}

                Your response must be a single valid JSON object containing an array of these technician routes. For example: { "optimizedRoutes": [ { "technicianName": "John Doe", "route": [...] } ] }
            `;

            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // Leave empty
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                // Check for errors in the AI response
                if (result.error) {
                    console.error("AI API Error:", result.error.message);
                    throw new Error(`AI API Error: ${result.error.message}`);
                }
                
                if (result.candidates && result.candidates[0].content.parts[0].text) {
                    const text = result.candidates[0].content.parts[0].text;
                    // Clean the response to remove markdown and ensure it's valid JSON
                    const cleanedJson = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    try {
                        optimizedRoutes = JSON.parse(cleanedJson).optimizedRoutes;
                        renderOptimizedRoutes(optimizedRoutes);
                        approveRoutesSection.style.display = 'block';
                    } catch (e) {
                        console.error("Failed to parse AI response JSON:", e);
                        throw new Error("Invalid JSON format in AI response.");
                    }
                } else {
                    // Handle other cases of unexpected structure
                    console.error("Unexpected AI response structure:", result);
                    throw new Error("Invalid response structure from AI.");
                }
            } catch (error) {
                console.error("Error optimizing routes:", error);
                optimizedRoutesContainer.innerHTML = '<p class="text-red-500 text-center py-4">Failed to optimize routes. Please check the console for errors.</p>';
            }
        }

        function renderOptimizedRoutes(routes) {
            optimizedRoutesContainer.innerHTML = '';
            routes.forEach(techRoute => {
                const tech = technicians.find(t => t.name === techRoute.technicianName);
                if (!tech) return;

                const techScheduleCard = document.createElement('div');
                techScheduleCard.className = 'p-3 bg-gray-50 rounded-lg';
                
                let jobsHtml = '';
                techRoute.route.forEach((job, index) => {
                    jobsHtml += `
                        <div class="flex items-start space-x-4">
                            <div class="flex items-center justify-center w-8 h-8 rounded-full bg-[var(--bg-orange)] text-white font-bold text-sm shrink-0">${index + 1}</div>
                            <div class="pt-1">
                                <p class="font-semibold text-sm text-gray-800">${job.issue}</p>
                                <p class="text-xs text-[var(--text-secondary)]">${job.address}</p>
                            </div>
                        </div>
                    `;
                });

                techScheduleCard.innerHTML = `
                    <div class="flex items-center space-x-3 mb-3 pb-3 border-b border-[var(--border-secondary)]">
                        <img alt="${tech.name}" class="w-8 h-8 rounded-full" src="${tech.avatar}" onerror="this.onerror=null;this.src='https://placehold.co/32x32/FFA500/000000?text=${tech.name.charAt(0)}';">
                        <div>
                            <p class="font-bold text-base text-gray-800">${tech.name}</p>
                            <p class="text-xs text-[var(--text-tertiary)]">${tech.id.substring(0,7)}...</p>
                        </div>
                    </div>
                    <div class="space-y-4">${jobsHtml}</div>
                `;
                optimizedRoutesContainer.appendChild(techScheduleCard);
            });
        }

        async function handleApproveRoutes() {
            if (!optimizedRoutes) {
                alert("No optimized routes to approve.");
                return;
            }
            
            approveRoutesBtn.disabled = true;
            approveRoutesBtn.textContent = 'Approving...';

            try {
                const batch = writeBatch(db);
                const today = new Date().toISOString().split('T')[0];
                
                optimizedRoutes.forEach(route => {
                    const docRef = doc(db, "optimized_routes", `${today}_${route.technicianName}`);
                    batch.set(docRef, {
                        technicianName: route.technicianName,
                        optimizedRoute: route.route,
                        approvedAt: serverTimestamp(),
                        date: today
                    });
                });

                await batch.commit();
                alert("Routes approved and saved successfully!");
                approveRoutesBtn.textContent = 'Routes Approved';
                approveRoutesSection.style.display = 'none';

            } catch (error) {
                console.error("Error approving routes:", error);
                alert("Failed to approve routes. Please check the console.");
                approveRoutesBtn.disabled = false;
                approveRoutesBtn.textContent = 'Approve and Send Routes';
            }
        }

        optimizeRoutesBtn.addEventListener('click', handleOptimizeRoutes);
        approveRoutesBtn.addEventListener('click', handleApproveRoutes);

        // --- Authentication and Initialization ---
        async function main() {
            setCalendarDate();
            try {
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");
                setupFirestoreListeners();
            } catch (error) {
                console.error("Anonymous authentication failed:", error);
            }
        }

        main();
    </script>
</body>
</html>
